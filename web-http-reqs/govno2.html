<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Image Upload</title>

    <!-- Import map for @stomp/stompjs -->
    <script type="importmap">
        {
          "imports": {
            "@stomp/stompjs": "https://ga.jspm.io/npm:@stomp/stompjs@7.0.0/esm6/index.js"
          }
        }
    </script>

    <!-- ES Module Shims (polyfill for older browsers) -->
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.5.1/dist/es-module-shims.js" crossorigin="anonymous"></script>
</head>
<body>
<h1>WebSocket Image Upload</h1>

<div>
    <label for="contentIdInput">Content ID:</label>
    <input type="text" id="contentIdInput" placeholder="Введите Content ID" />
</div>
<div>
    <label for="imageInput">Выберите изображение:</label>
    <input type="file" id="imageInput" accept="image/*" />
    <button onclick="uploadImage()">Загрузить изображение</button>
</div>

<div>
    <h2>Статус:</h2>
    <div>
        <label for="statusIdInput">Введите ID:</label>
        <input type="text" id="statusIdInput" placeholder="Введите ID" />
        <button onclick="fetchStatus()">Получить статус</button>
    </div>
    <ul id="statusMessages"></ul>
</div>

<script type="module">
    import { Client } from '@stomp/stompjs';

    let client;

    function connect() {
        client = new Client({
            brokerURL: 'ws://localhost:8066/ws/poster', // Замените на ваш WebSocket URL
            onConnect: () => {
                console.log('Connected');
            },
            onWebSocketError: error => {
                console.error('Ошибка подключения:', error);
            }
        });

        client.activate();
    }

    window.uploadImage = function uploadImage() {
        const contentIdInput = document.getElementById('contentIdInput');
        const imageInput = document.getElementById('imageInput');
        const contentId = contentIdInput.value;
        const file = imageInput.files[0];

        if (!contentId || !file) {
            alert('Пожалуйста, укажите Content ID и выберите изображение.');
            return;
        }

        const reader = new FileReader();
        reader.onload = () => {
            const base64Image = reader.result.split(',')[1]; // Извлечение Base64 строки
            const messageObject = {
                content_id: contentId, // Поле contentId
                data: base64Image     // Поле с изображением в формате Base64
            };
            const messageJson = JSON.stringify(messageObject); // Преобразование в JSON-строку

            if (client && client.connected) {
                client.publish({ destination: '/app/upload', body: messageJson });
                //TODO здесь надо получить реальное подтверждение от сервера  /topic/status
                console.log('Изображение отправлено');
            } else {
                console.error('Не подключен к серверу WebSocket');
            }
        };

        reader.onerror = error => {
            console.error('Ошибка чтения файла:', error);
        };

        reader.readAsDataURL(file);
    };

    window.fetchStatus = async function fetchStatus() {
        const statusIdInput = document.getElementById('statusIdInput');
        const statusId = statusIdInput.value;

        if (!statusId) {
            alert('Пожалуйста, укажите ID.');
            return;
        }

        try {
            const response = await fetch("http://localhost:8066/api/v1/poster/95");

            if (!response.ok) {
                throw new Error(`Ошибка: ${response.statusText}`);
            }

            const imageData = await response.json();

            if (imageData && imageData.data) {
                displayImage(imageData.data);
            } else {
                alert('Изображение не найдено.');
            }
        } catch (error) {
            console.error('Ошибка при получении данных:', error);
            alert('Ошибка при получении данных. Проверьте консоль для подробностей.');
        }
    };

    function displayImage(base64Image) {
        const statusMessagesList = document.getElementById('statusMessages');
        const statusItem = document.createElement('li');
        const img = document.createElement('img');
        img.src = `data:image/png;base64,${base64Image}`;
        img.alt = 'Status Image';
        img.style.maxWidth = '200px';
        img.style.maxHeight = '200px';

        statusItem.appendChild(img);
        statusMessagesList.appendChild(statusItem);
    }

    window.onload = connect;
</script>
</body>
</html>